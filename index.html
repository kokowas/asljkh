<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Adjectif Ã‰pithÃ¨te - LeÃ§on Interactive</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        :root {
            --highlight-bg: #fde68a;
            --adj-color: #f59e0b;
            --noun-color: #10b981;
            --verb-color: #dc2626;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        /* Whiteboard & Container Styles */
        .whiteboard-frame {
            background: linear-gradient(145deg, #2c2c2c 0%, #1a1a1a 100%);
            padding: 8px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.1);
            width: 100%; max-width: 900px;
            margin: 0 auto; transition: max-width 0.3s ease-in-out;
        }
        
        .whiteboard-content { background: white; border-radius: 4px; overflow: hidden; min-height: 85vh; }
        .container { max-width: 100%; padding: 40px; min-height: 80vh; }
        
        /* Step & Slide Styles */
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.8s ease forwards; }
        .slide-step { display: none; }
        .slide-step.visible { display: block; animation: fadeInUp 0.6s ease forwards; }
        .step-navigation { text-align: center; margin-top: 20px; }
        .step-next-btn {
            background: #667eea; color: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: inline-flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .step-next-btn:hover { transform: scale(1.1); }
        .step-next-btn svg { width: 24px; height: 24px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography & Content Boxes */
        h1, h2, h3, h4 { text-align: center; margin-bottom: 15px; }
        h1 {
            font-size: clamp(1.8em, 5vw, 2.5em);
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        p, .subtitle {
            font-size: clamp(1.1em, 2.5vw, 1.3em); line-height: 1.8;
            color: #34495e; text-align: center; margin-bottom: 0;
        }
        .content-box, .definition-box, .key-point, .example-box, .counter-example, .warning-box, .activity-box {
            padding: clamp(20px, 3vw, 30px); border-radius: 15px;
            margin: 25px auto; border-left: 5px solid; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .definition-box { border-color: #4caf50; background: #f1f8e9; }
        .example-box { border-color: #2196f3; background: #e3f2fd; }
        .key-point { border-color: #ff9800; background: #fff8e1; }
        .counter-example { border-color: #f44336; background: #ffebee; }
        .warning-box { border-color: #dc2626; background: #fee2e2; }
        .example-phrase { font-size: clamp(1.4em, 4vw, 1.9em); font-weight: 600; }
        
        /* Word Coloring */
        .adj { color: var(--adj-color); font-weight: 900; }
        .noun { color: var(--noun-color); font-weight: 600; }
        .verb { color: var(--verb-color); font-weight: 900; text-decoration: underline; }

        /* TTS & Highlighting Styles */
        .word.highlight {
            background-color: var(--highlight-bg); color: black !important;
            padding: 0 3px; border-radius: 4px;
        }
        h1 .word.highlight {
            background: var(--highlight-bg) !important; -webkit-text-fill-color: black;
            color: black !important; background-clip: border-box !important; -webkit-background-clip: border-box !important;
        }
        .replay-audio-btn {
            background: none; border: none; cursor: pointer; font-size: 1.5em;
            opacity: 0; transition: all 0.3s; vertical-align: middle; margin-left: 10px;
        }
        .replay-audio-btn.visible { opacity: 0.8; }
        .replay-audio-btn:hover { transform: scale(1.2); opacity: 1; }

        /* Navigation & Progress */
        .navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; gap: 15px; }
        .nav-btn {
            flex: 1; min-width: 120px; padding: 15px 30px; font-size: 1.1em;
            font-weight: 600; border: none; border-radius: 12px; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .nav-btn:hover { transform: translateY(-2px); }
        .prev-btn { background: #95a5a6; color: white; }
        .next-btn { background: #667eea; color: white; }
        .start-btn { background: #4caf50; color: white; width: auto; max-width: 400px; font-size: 1.4em; }
        .replay-btn { width: 100%; padding: 20px; font-size: 1.3em; background: white; color: #667eea; }
        #retryQuizBtn { background: #f39c12; color: white; }
        
        .progress-container { background: #ecf0f1; height: 10px; border-radius: 10px; margin: 30px 0 20px; visibility: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.5s ease; }
        .step-indicator { text-align: center; color: #7f8c8d; font-weight: 600; margin-bottom: 20px; font-size: 1.1em; visibility: hidden; }

        /* Quiz Styling */
        .activity-box { border-color: #9e9d24; background: #f0f4c3; }
        .activity-box h3 { color: #827717; }
        .quiz-option-btn {
            background: white; border: 3px solid #bdc3c7; padding: 20px;
            margin: 15px 0; cursor: pointer; border-radius: 15px;
            transition: all 0.3s ease; font-size: clamp(1.1em, 2.5vw, 1.3em);
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .quiz-option-btn:not([data-answered]):hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); border-color: #667eea; }
        .quiz-option-btn.correct { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; transform: scale(1.02); }
        .quiz-option-btn.incorrect { background: #ffebee; border-color: #f44336; color: #c62828; opacity: 0.8; }
        .quiz-option-btn[data-answered] { cursor: not-allowed; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: 600; text-align: center; animation: fadeInUp 0.5s; }
        .feedback.correct { background: #c8e9c9; color: #2e7d32; }
        .feedback.incorrect { background: #ffcdd2; color: #c62828; }
        
        /* UI Buttons (Translate, Fullscreen) */
        .ui-buttons { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px; }
        .arabic-toggle, .fullscreen-btn {
            background: rgba(255, 255, 255, 0.9); border: none;
            width: 45px; height: 45px; border-radius: 50%;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .arabic-toggle { background: #f59e0b; color: white; font-weight: 600; font-size: 1.2em; }
        .fullscreen-btn { color: #667eea; }
        .arabic-toggle:hover, .fullscreen-btn:hover { transform: translateY(-2px); }
        .fullscreen-btn svg { width: 24px; height: 24px; fill: currentColor; }

        .arabic-text {
            display: none; background: #fff8e1; border: 2px solid #f59e0b; padding: 15px;
            border-radius: 10px; margin-top: 20px; direction: rtl; font-family: 'Arial', sans-serif;
        }
        .arabic-text.show { display: block; animation: fadeInUp 0.5s; }

        /* WIDESCREEN RESPONSIVENESS */
        @media (min-width: 1200px) { .whiteboard-frame { max-width: 1400px; } body { padding: 40px; } }
        /* MOBILE RESPONSIVENESS (UNCHANGED) */
        @media (max-width: 480px) { body { padding: 10px; } .container { padding: 15px; } p, .subtitle { font-size: 1em; } }
    </style>
</head>
<body>
    <div class="ui-buttons">
        <button class="fullscreen-btn" onclick="toggleFullscreen()">
            <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
        </button>
        <button class="arabic-toggle" onclick="toggleArabic()"><span id="toggleText">ğŸŒ</span></button>
    </div>

    <div class="whiteboard-frame">
        <div class="whiteboard-content">
            <div class="container">
                <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
                <div class="step-indicator" id="stepIndicator"></div>

                <div id="step0" class="step-container">
                    <div class="step-content" style="text-align: center; padding: 50px 0;">
                        <h1>Bienvenue !</h1>
                        <p style="margin-bottom: 40px;">PrÃªt Ã  apprendre sur l'adjectif Ã©pithÃ¨te ?</p>
                        <button class="nav-btn start-btn" onclick="startLesson()">Commencer la leÃ§on âœ¨</button>
                    </div>
                </div>

                <div id="step1" class="step-container">
                    <div class="step-content">
                        <div class="slide-step">
                            <h1 class="tts-text" data-audio-src="audio/s1p1.wav">L'Adjectif Ã‰pithÃ¨te.</h1>
                            <div class="arabic-text"><p>Ø§Ù„ØµÙØ© Ø§Ù„Ù…Ù„Ø§Ø²Ù…Ø©.</p></div>
                        </div>
                        <div class="slide-step">
                            <div class="content-box">
                                <p class="tts-text" data-audio-src="audio/s1p2.wav">Bonjour ! Aujourd'hui, on va apprendre quelque chose de trÃ¨s simple : l'adjectif Ã©pithÃ¨te ! C'est facile, tu vas voir ! ğŸ˜Š</p>
                                <div class="arabic-text">
                                    <h3>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹!</h3>
                                    <p>Ø§Ù„ÙŠÙˆÙ… Ø³Ù†ØªØ¹Ù„Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø¨Ø³ÙŠØ·Ø§Ù‹ Ø¬Ø¯Ø§Ù‹: Ø§Ù„ØµÙØ© Ø§Ù„Ù…Ù„Ø§Ø²Ù…Ø©! Ø³Ù‡Ù„ Ø¬Ø¯Ø§Ù‹ØŒ Ø³ØªØ±Ù‰! ğŸ˜Š</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="navigation"><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div>
                </div>

                <div id="step2" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" data-audio-src="audio/s2p1.wav">C'est quoi ?</h1><div class="arabic-text"><p>Ù…Ø§ Ù‡Ø°Ø§ØŸ</p></div></div><div class="slide-step"><div class="definition-box"><p class="tts-text" data-audio-src="audio/s2p2.wav">C'est un mot qui dÃ©crit et qui est collÃ© au nom !</p><div class="arabic-text"><p>Ù‡ÙŠ ÙƒÙ„Ù…Ø© ØªØµÙ Ø§Ù„Ø§Ø³Ù… ÙˆØªÙƒÙˆÙ† Ù…Ù„ØªØµÙ‚Ø© Ø¨Ù‡!</p></div></div></div><div class="slide-step"><div class="example-box"><p class="tts-text example-phrase" data-audio-src="audio/s2p3.wav">Exemple : Un <span class="adj">BEAU</span> <span class="noun">jardin</span>. "BEAU" dÃ©crit le jardin ! ğŸŒ³</p><div class="arabic-text"><p>Ù…Ø«Ø§Ù„: Ø­Ø¯ÙŠÙ‚Ø© Ø¬Ù…ÙŠÙ„Ø© ğŸŒ³ "Ø¬Ù…ÙŠÙ„Ø©" ØªØµÙ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©!</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div></div>
                <div id="step3" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" data-audio-src="audio/s3p1.wav">Il dÃ©crit le nom.</h1><div class="arabic-text"><p>Ø¥Ù†Ù‡ ÙŠØµÙ Ø§Ù„Ø§Ø³Ù….</p></div></div><div class="slide-step"><div class="example-box"><p class="tts-text" data-audio-src="audio/s3p2.wav">L'adjectif Ã©pithÃ¨te DÃ‰CRIT le nom. ğŸ¯ Un <span class="adj">BEAU</span> <span class="noun">jardin</span>. "BEAU" dÃ©crit comment est le jardin.</p><div class="arabic-text"><p>Ø§Ù„ØµÙØ© ØªØµÙ Ø§Ù„Ø§Ø³Ù…. Ù…Ø«Ø§Ù„: "Ø¬Ù…ÙŠÙ„Ø©" ØªØµÙ ÙƒÙŠÙ ØªØ¨Ø¯Ùˆ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div></div>
                <div id="step4" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" data-audio-src="audio/s4p1.wav">Avant ou AprÃ¨s ?</h1><div class="arabic-text"><p>Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ØŸ</p></div></div><div class="slide-step"><div class="example-box"><p class="tts-text example-phrase" data-audio-src="audio/s4p2.wav">â¬…ï¸ AVANT le nom. Un <span class="adj">GRAND</span> <span class="noun">arbre</span>. ğŸŒ³</p><div class="arabic-text"><p>â¬…ï¸ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³Ù…: Ø´Ø¬Ø±Ø© ÙƒØ¨ÙŠØ±Ø©</p></div></div></div><div class="slide-step"><div class="example-box"><p class="tts-text example-phrase" data-audio-src="audio/s4p3.wav">â¡ï¸ APRÃˆS le nom. Un <span class="noun">chat</span> <span class="adj">NOIR</span>. ğŸ±</p><div class="arabic-text"><p>â¡ï¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù…: Ù‚Ø·Ø© Ø³ÙˆØ¯Ø§Ø¡</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div></div>
                <div id="step5" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" data-audio-src="audio/s5p1.wav">Des Exemples !</h1><div class="arabic-text"><p>Ø£Ù…Ø«Ù„Ø©!</p></div></div><div class="slide-step"><div class="example-box"><p class="tts-text example-phrase" data-audio-src="audio/s5p2.wav">Un <span class="adj">GRAND</span> <span class="noun">arbre</span>. ğŸŒ³</p><div class="arabic-text"><p>ğŸŒ³ Ø´Ø¬Ø±Ø© ÙƒØ¨ÙŠØ±Ø©</p></div></div></div><div class="slide-step"><div class="example-box"><p class="tts-text example-phrase" data-audio-src="audio/s5p3.wav">Une <span class="adj">PETITE</span> <span class="noun">maison</span>. ğŸ </p><div class="arabic-text"><p>ğŸ  Ù…Ù†Ø²Ù„ ØµØºÙŠØ±</p></div></div></div><div class="slide-step"><div class="example-box"><p class="tts-text example-phrase" data-audio-src="audio/s5p4.wav">Un <span class="noun">chat</span> <span class="adj">NOIR</span>. ğŸ±</p><div class="arabic-text"><p>ğŸ± Ù‚Ø·Ø© Ø³ÙˆØ¯Ø§Ø¡</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div></div>
                <div id="step6" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" data-audio-src="audio/s6p1.wav">Comment le trouver ?</h1><div class="arabic-text"><p>ÙƒÙŠÙ ØªØ¬Ø¯Ù‡ØŸ</p></div></div><div class="slide-step"><div class="key-point"><p class="tts-text" data-audio-src="audio/s6p2.wav">Cherche le mot qui dÃ©crit, juste Ã  cÃ´tÃ© du nom !</p><div class="arabic-text"><p>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ ØªØµÙØŒ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø§Ø³Ù… Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹!</p></div></div></div><div class="slide-step"><div class="example-box"><p class="tts-text" data-audio-src="audio/s6p3.wav">âœ“ CORRECT. Un <span class="adj">BEAU</span> <span class="noun">chien</span>. Pas de verbe entre les mots !</p><div class="arabic-text"><p>âœ“ ØµØ­ÙŠØ­: ÙƒÙ„Ø¨ Ø¬Ù…ÙŠÙ„ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ¹Ù„ Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª!)</p></div></div></div><div class="slide-step"><div class="counter-example"><p class="tts-text" data-audio-src="audio/s6p4.wav">âœ— FAUX. Le <span class="noun">chien</span> <span class="verb">EST</span> <span class="adj">beau</span>. Il y a un verbe "EST" !</p><div class="arabic-text"><p>âœ— Ø®Ø·Ø£: Ø§Ù„ÙƒÙ„Ø¨ Ø¬Ù…ÙŠÙ„ (ÙŠÙˆØ¬Ø¯ ÙØ¹Ù„ "EST"!)</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div></div>
                <div id="step7" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" style="color: #dc2626;" data-audio-src="audio/s7p1.wav">âš ï¸ ATTENTION !</h1><div class="arabic-text"><p>âš ï¸ Ø§Ù†ØªØ¨Ø§Ù‡!</p></div></div><div class="slide-step"><div class="warning-box"><p class="tts-text" data-audio-src="audio/s7p2.wav">Ne pas confondre ! L'adjectif Ã©pithÃ¨te ne doit JAMAIS avoir de <span class="verb">verbe</span> entre lui et le nom.</p><div class="arabic-text"><p>Ù„Ø§ ØªØ®Ù„Ø·! Ø§Ù„ØµÙØ© Ø§Ù„Ù…Ù„Ø§Ø²Ù…Ø© ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø£Ø¨Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ ÙØ¹Ù„ Ø¨ÙŠÙ†Ù‡Ø§ ÙˆØ¨ÙŠÙ† Ø§Ù„Ø§Ø³Ù….</p></div></div></div><div class="slide-step"><div class="key-point"><p class="tts-text" data-audio-src="audio/s7p3.wav">Si PAS de verbe, c'est Ã‰PITHÃˆTE. âœ… Si il y a un VERBE, c'est ATTRIBUT. âŒ</p><div class="arabic-text"><p>âœ… Ø¨Ø¯ÙˆÙ† ÙØ¹Ù„ = ØµÙØ© Ù…Ù„Ø§Ø²Ù…Ø©<br>âŒ Ù…Ø¹ ÙØ¹Ù„ = ØµÙØ© Ù…Ù†Ø³ÙˆØ¨Ø©</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button class="nav-btn next-btn" onclick="nextStep()">Suivant â†’</button></div></div>
                <div id="step8" class="step-container"><div class="step-content"><div class="slide-step"><h1 class="tts-text" data-audio-src="audio/s8p1.wav">ğŸ® Ã€ toi de jouer !</h1><div class="arabic-text"><p>ğŸ® Ø­Ø§Ù† Ø¯ÙˆØ±Ùƒ Ù„Ù„Ø¹Ø¨!</p></div></div><div class="slide-step"><div class="activity-box"><h3 class="tts-text" data-audio-src="audio/s8p2.wav">Trouve la phrase avec un adjectif <strong>Ã©pithÃ¨te</strong> !</h3><div id="quiz-container"></div><div id="feedback"></div><div class="arabic-text"><p>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙØ© Ù…Ù„Ø§Ø²Ù…Ø©!</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button><button id="retryQuizBtn" class="nav-btn" style="display: none;" onclick="initializeQuiz()">ğŸ”„ RÃ©essayer</button></div></div>
                <div id="step9" class="step-container"><div class="step-content"><div class="slide-step"><div class="content-box"><p class="tts-text example-phrase" data-audio-src="audio/s9p1.wav">ğŸ‰ Bravo ! Tu as tout compris ! Tu sais maintenant ce qu'est l'adjectif Ã©pithÃ¨te ! ğŸ†</p><button class="nav-btn replay-btn" onclick="replayLesson()">ğŸ”„ Recommencer la leÃ§on</button><div class="arabic-text"><h3>ğŸ‰ Ø£Ø­Ø³Ù†Øª!</h3><p>Ù„Ù‚Ø¯ ÙÙ‡Ù…Øª ÙƒÙ„ Ø´ÙŠØ¡! Ø£Ù†Øª ØªØ¹Ø±Ù Ø§Ù„Ø¢Ù† Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØµÙØ© Ø§Ù„Ù…Ù„Ø§Ø²Ù…Ø©!</p></div></div></div></div><div class="navigation"><button class="nav-btn prev-btn" onclick="prevStep()">â† Retour</button></div></div>

            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 10;
        let activeAudio = null;
        let highlightInterval = null;
        const originalHTMLs = new Map();
        let showArabic = false;
        let userHasInteracted = false;

        const quizData = [
            { text: 'Le chat <span class="verb">EST</span> gros ğŸ±', correct: false },
            { text: 'Un <span class="adj">GROS</span> chat ğŸ±', correct: true }
        ];
        
        function startLesson() {
            userHasInteracted = true;
            document.querySelector('.progress-container').style.visibility = 'visible';
            document.querySelector('.step-indicator').style.visibility = 'visible';
            nextStep();
        }

        function toggleArabic() {
            showArabic = !showArabic;
            document.querySelectorAll('.arabic-text').forEach(text => text.classList.toggle('show', showArabic));
        }

        function showStep(stepIndex) {
            stopAndResetAudio();
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active'));
            const targetStep = document.getElementById('step' + stepIndex);
            targetStep.classList.add('active');
            
            const stepContent = targetStep.querySelector('.step-content');
            if (stepContent) {
                const innerSteps = Array.from(stepContent.querySelectorAll('.slide-step'));
                innerSteps.forEach((inner, index) => inner.classList.toggle('visible', index === 0));

                if (innerSteps.length > 0) playTTSForStep(innerSteps[0]);

                let stepNav = targetStep.querySelector('.step-navigation');
                if (!stepNav) {
                    stepNav = document.createElement('div');
                    stepNav.className = 'step-navigation';
                    targetStep.appendChild(stepNav);
                }
                stepNav.style.display = (innerSteps.length > 1) ? 'block' : 'none';
                if (innerSteps.length > 1) {
                    stepNav.innerHTML = `<button class="step-next-btn" onclick="nextInnerStep()"><svg fill="white" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button>`;
                }
            }

            const mainNav = targetStep.querySelector('.navigation');
            if (mainNav) {
                mainNav.style.display = stepContent.querySelectorAll('.slide-step').length <= 1 ? 'flex' : 'none';
            }
        }

        function nextInnerStep() {
            const activeStepContainer = document.querySelector('.step-container.active');
            const nextStepToShow = activeStepContainer.querySelector('.slide-step:not(.visible)');
            if (nextStepToShow) {
                nextStepToShow.classList.add('visible');
                playTTSForStep(nextStepToShow);
            }

            if (!activeStepContainer.querySelector('.slide-step:not(.visible)')) {
                activeStepContainer.querySelector('.step-navigation').style.display = 'none';
                activeStepContainer.querySelector('.navigation').style.display = 'flex';
            }
        }
        
        const changeStep = (direction) => {
            currentStep += direction;
            if (currentStep < 0) currentStep = 0;
            if (currentStep >= totalSteps) currentStep = totalSteps - 1;
            showStep(currentStep);
            if (currentStep === 8) initializeQuiz();
            updateProgress();
        };

        const nextStep = () => changeStep(1);
        const prevStep = () => changeStep(-1);
        
        function updateProgress() {
            if (currentStep === 0) return;
            const progress = ((currentStep - 1) / (totalSteps - 2)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('stepIndicator').textContent = `Ã‰tape ${currentStep} / ${totalSteps-1}`;
        }

        function replayLesson() {
            document.querySelector('.progress-container').style.visibility = 'hidden';
            document.querySelector('.step-indicator').style.visibility = 'hidden';
            currentStep = 0; 
            showStep(0); 
            updateProgress(); 
        }

        function initializeQuiz() {
            const container = document.getElementById('quiz-container');
            const retryBtn = document.getElementById('retryQuizBtn');
            if(retryBtn) retryBtn.style.display = 'none';
            container.innerHTML = '';
            document.getElementById('feedback').innerHTML = '';
            const shuffledQuizData = [...quizData].sort(() => Math.random() - 0.5);

            shuffledQuizData.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'quiz-option-btn';
                div.innerHTML = opt.text;
                div.dataset.correct = opt.correct;
                div.onclick = () => checkAnswer(div);
                container.appendChild(div);
            });
        }
        
        function checkAnswer(selectedElement) {
            const allOptions = document.querySelectorAll('.quiz-option-btn');
            if (allOptions[0].dataset.answered) return;
            allOptions.forEach(btn => btn.dataset.answered = 'true');

            const isCorrect = selectedElement.dataset.correct === 'true';
            const correctElement = Array.from(allOptions).find(btn => btn.dataset.correct === 'true');
            const feedbackEl = document.getElementById('feedback');
            const retryBtn = document.getElementById('retryQuizBtn');

            if (isCorrect) {
                selectedElement.classList.add('correct');
                feedbackEl.innerHTML = `<div class="feedback correct">ğŸ‰ Bravo ! C'est la bonne rÃ©ponse !</div>`;
                setTimeout(nextStep, 2000);
            } else {
                selectedElement.classList.add('incorrect');
                if (correctElement) correctElement.classList.add('correct');
                feedbackEl.innerHTML = `<div class="feedback incorrect">âŒ Pas tout Ã  fait... Regarde bien la bonne rÃ©ponse.</div>`;
                if(retryBtn) retryBtn.style.display = 'block';
            }
        }

        function stopAndResetAudio() {
            if (activeAudio) { activeAudio.pause(); activeAudio.currentTime = 0; }
            clearInterval(highlightInterval);
            originalHTMLs.forEach((html, element) => { if (element) element.innerHTML = html; });
            originalHTMLs.clear();
            document.querySelectorAll('.replay-audio-btn').forEach(btn => btn.remove());
        }
        
        function wrapWordsInElement(element) {
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            const nodes = [];
            while(walker.nextNode()) { if (walker.currentNode.textContent.trim()) nodes.push(walker.currentNode); }
            
            nodes.forEach(node => {
                const words = node.textContent.split(/\s+/).filter(Boolean);
                const fragment = document.createDocumentFragment();
                words.forEach((word, i) => {
                    const span = document.createElement('span');
                    span.className = 'word';
                    span.textContent = word;
                    fragment.appendChild(span);
                    if (i < words.length - 1) fragment.appendChild(document.createTextNode(' '));
                });
                if(node.parentNode) node.parentNode.replaceChild(fragment, node);
            });
        }

        function playTTSForStep(stepElement, forcePlay = false) {
            stopAndResetAudio();
            const textElement = stepElement.querySelector('.tts-text');
            if (!textElement || !textElement.dataset.audioSrc) return;
            
            originalHTMLs.set(textElement, textElement.innerHTML);
            const plainText = textElement.textContent;
            wrapWordsInElement(textElement);
            const wordSpans = textElement.querySelectorAll('.word');

            const replayBtn = document.createElement('button');
            replayBtn.className = 'replay-audio-btn';
            replayBtn.innerHTML = 'ğŸ”Š';
            textElement.parentNode.insertBefore(replayBtn, textElement.nextSibling);
            replayBtn.onclick = () => { playTTSForStep(stepElement, true); };
            
            if (!userHasInteracted && !forcePlay) {
                replayBtn.classList.add('visible');
                return; 
            }

            activeAudio = new Audio(textElement.dataset.audioSrc);
            activeAudio.play().catch(e => {
                console.error("Audio failed:", e);
                replayBtn.classList.add('visible');
            });

            activeAudio.addEventListener('loadedmetadata', () => {
                const timings = estimateWordTimings(plainText.split(/\s+/).filter(Boolean), activeAudio.duration);
                highlightInterval = setInterval(() => {
                    const currentTime = activeAudio.currentTime;
                    let currentWordIndex = timings.findIndex(t => currentTime >= t.start && currentTime < t.end);
                    wordSpans.forEach((span, i) => span.classList.toggle('highlight', i === currentWordIndex));
                }, 50);
            });

            activeAudio.onended = () => {
                clearInterval(highlightInterval);
                wordSpans.forEach(span => span.classList.remove('highlight'));
                replayBtn.classList.add('visible');
            };
        }

        function estimateWordTimings(words, duration) {
            const totalChars = words.join('').length;
            if (totalChars === 0) return [];
            const timings = [];
            let time = 0;
            words.forEach(word => {
                const wordDuration = (word.length / totalChars) * duration * 0.95;
                timings.push({ start: time, end: time + wordDuration });
                time += wordDuration;
            });
            return timings;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.error(err));
            } else {
                document.exitFullscreen();
            }
        }
        document.addEventListener('fullscreenchange', () => {
            const btn = document.querySelector('.fullscreen-btn');
            const isFullscreen = !!document.fullscreenElement;
            btn.innerHTML = isFullscreen 
                ? `<svg viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>`
                : `<svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>`;
        });

        document.addEventListener('DOMContentLoaded', () => { showStep(0); });
    </script>
</body>
</html>
